[General]
modid=76867
version=1.2.0.0
newestVersion=1.2.0.0
category="42,"
installationFile=Recursion Fix-76867-1-2-1666911818.rar
gameName=SkyrimSE
nexusFileStatus=1
repository=Nexus
ignoredVersion=
comments=
notes=
nexusDescription="[b][size=6][color=#11FF00]H[/color][color=#17FF0E]o[/color][color=#1DFF1C]w[/color] [color=#29FF38]t[/color][color=#2FFF46]o[/color] [color=#3BFF62]I[/color][color=#34FF55]n[/color][color=#2EFF48]s[/color][color=#28FF3B]t[/color][color=#22FF2E]a[/color][color=#1CFF21]l[/color][color=#16FF14]l\n<br />[/color][/size][/b]Install with your preferred mod manager like any other mod!\n<br />\n<br />For VR users: make sure to download the latest version of VR address library (v0.53 and up) as this mod requires the changes made in that version.\n<br />\n<br />[b][size=6][color=#11FF00]T[/color][color=#1FFF20]h[/color][color=#2DFF41]e[/color] [color=#2CFF44]b[/color][color=#1EFF26]u[/color][color=#0FFF08]g[/color][/size][/b]\n<br />\n<br />[b][size=4][color=#FFC812]S[/color][color=#FECB16]h[/color][color=#FECF1B]o[/color][color=#FDD31F]r[/color][color=#FDD724]t[/color] [color=#FCDF2D]a[/color][color=#FCE331]n[/color][color=#FBE736]d[/color] [color=#FAEF3F]s[/color][color=#FAF344]i[/color][color=#F9F748]m[/color][color=#F9FB4D]p[/color][color=#F9FE51]l[/color][color=#F9FC50]e[/color] [color=#FAF64C]e[/color][color=#FAF34A]x[/color][color=#FBF048]p[/color][color=#FBED46]l[/color][color=#FCEA44]a[/color][color=#FCE843]n[/color][color=#FCE541]a[/color][color=#FDE23F]t[/color][color=#FDDF3D]i[/color][color=#FEDC3B]o[/color][color=#FED939]n[/color][/size][/b]\n<br />\n<br />[spoiler]Unlike most other programming languages Papyrus does not have what is referred to as a \"stack overflow\", which is an error most commonly thrown to stop functions from recursively calling themselves infinitely, which would create a much worse kind of infinite loop. Although papyrus can [i]technically[/i] handle a function calling itself 1000's to hundreds of thousand of times by its underlying implementation, it comes at the cost of your framerate.\n<br />\n<br />Since a function calling itself hundreds of times is usually related to a bug and [b]not[/b] intended behavior, this mod breaks the recursion after a thousand calls. This way your framerate will not be affected, and the already broken mod that would've caused framerate lag will simply remain broken.[/spoiler]\n<br />\n<br />[b][size=4][color=#FFC812]S[/color][color=#FECC16]u[/color][color=#FED01B]p[/color][color=#FDD420]e[/color][color=#FDD825]r[/color] [color=#FCE12F]T[/color][color=#FBE534]e[/color][color=#FBE939]c[/color][color=#FAEE3E]h[/color][color=#FAF243]n[/color][color=#F9F648]i[/color][color=#F9FA4D]c[/color][color=#F9FE51]a[/color][color=#F9FB4F]l[/color] [color=#FAF54B]E[/color][color=#FAF249]x[/color][color=#FBEF47]p[/color][color=#FBEC45]l[/color][color=#FCE943]a[/color][color=#FCE641]n[/color][color=#FDE33F]a[/color][color=#FDE03D]t[/color][color=#FEDD3B]i[/color][color=#FEDA39]o[/color][color=#FFD737]n[/color][/size][/b]\n<br />\n<br />[spoiler]Skyrim spends around 1.2ms of each frame handling papyrus background tasks (suspending stacks, freezing stacks, handling any `OnUpdate` `OnWait` calls, etc.) at most, but it will always process tasklets (the actual script code to run) up to 100 operations of a function at a time, and does [b]not[/b] have any checks for how long it is processing. Usually this is fine, as tasklets complete really quick, and papyrus background tasks always abide by 1.2ms (or whatever you set in the ini) of time to run per frame\n<br />\n<br />Every time the script code requires a function call, the stack for the currently running code has to push a new stackframe if the function call is valid. I haven't narrowed down exactly why or how, but this pushing of the new stackframe takes longer when there are more stackframes in the stack already. This all occurs in `AttemptFunctionCall` on the VirtualMachine. This method runs a bunch of checks on making sure the function call is valid (correct arg types, etc.), then allocates a new stackframe before actually calling the function. \n<br />\n<br />To break the recursion, this mod hooks right before the initial check that checks if the stack is valid, the function call query is valid and the function call info returns a valid result. At that hook point, this mod adds an additional check for recursion:\n<br />\n<br />[color=#EAD1FF]static RE::BSFixedString* thunk(std::uint64_t unk0, RE::BSScript::Stack* a_stack, std::uint64_t* a_funcCallQuery)\n<br />    {\n<br />        if (a_stack != nullptr &amp;&amp; a_stack-&gt;frames &gt; 1000) { // checks if we are already 1000 frames (calls) deep\n<br />            logger::info(\"Detected 1000+ recursive call! Will throw error in papyrus log\"); // print error in custom log\n<br />            *a_funcCallQuery = 0; // sets funcCallQuery to \"nullptr\" to trick skyrim into thinking the function call is invalid\n<br />        }\n<br />        return func(unk0, a_stack, a_funcCallQuery);\n<br />    }[/color]\n<br />\n<br />If this mod detects the 1000+ calls, it'll set \"a_funcCallQuery\" to  \"nullptr\" which makes Skyrim think the call is invalid:\n<br />\n<br />[color=#E5FFD4]if ( !stack                               // decompiled skyrim code\n<br />    || !funcCallQuery-&gt;_ptr\n<br />    || !(funcCallQuery-&gt;_ptr-&gt;vftable_IFuncCallQuery_0-&gt;GetFunctionCallInfo_8)(\n<br />          funcCallQuery-&gt;_ptr,\n<br />          &amp;a_callType,\n<br />          &amp;a_objectTypeInfo,\n<br />          &amp;functionName,\n<br />          &amp;a_variable,\n<br />          &amp;a_arg5) )\n<br />  {\n<br />    sub_141240A50(stack, \"Unable to obtain function call information - returning None\", 2u, vNoFuncStr, 1024);\n<br />    v14 = vNoFuncStr;\n<br />    goto LABEL_105;\n<br />  }[/color]\n<br />\n<br />then this mod hook the log function that normally would say \"Unable to obtain function call information - returning None\" to instead say \"StackFrameOverFlow exception, function call exceeded 1000 call stack limit - returning None\", so anyone seeing the logs will know it was this mod breaking the recursion[/spoiler]\n<br />\n<br />[b][size=6][color=#03FF03]W[/color][color=#06FF06]a[/color][color=#09FF09]n[/color][color=#0CFF0C]t[/color] [color=#13FF13]t[/color][color=#16FF16]o[/color] [color=#1CFF1C]w[/color][color=#1FFF1F]i[/color][color=#23FF23]t[/color][color=#26FF26]n[/color][color=#29FF29]e[/color][color=#2CFF2C]s[/color][color=#30FF30]s[/color] [color=#36FF36]t[/color][color=#39FF39]h[/color][color=#3CFF3C]e[/color] [color=#36FF36]b[/color][color=#33FF33]u[/color][color=#30FF30]g[/color] [color=#29FF29]f[/color][color=#26FF26]o[/color][color=#23FF23]r[/color] [color=#1CFF1C]y[/color][color=#19FF19]o[/color][color=#16FF16]u[/color][color=#13FF13]r[/color][color=#0FFF0F]s[/color][color=#0CFF0C]e[/color][color=#09FF09]l[/color][color=#06FF06]f[/color][color=#03FF03]?[/color][/size][/b]\n<br />\n<br />[spoiler]If you want to test this behavior yourself you can download the recursion bug demo from the miscellaneous section in the downloads. It starts on game load and depending on your rig will take about 2 to 3 minutes for the frame drop to become unbearable and is still getting worse the longer it runs.\n<br />[size=3][color=#FF0F0F]W[/color][color=#FF0F0F]A[/color][color=#FF1010]R[/color][color=#FF1111]N[/color][color=#FF1212]I[/color][color=#FF1212]N[/color][color=#FF1313]G[/color][color=#FF1414]:[/color] [color=#FF1616]D[/color][color=#FF1616]o[/color] [color=#FF1818]n[/color][color=#FF1919]o[/color][color=#FF1A1A]t[/color] [color=#FF1B1B]l[/color][color=#FF1C1C]e[/color][color=#FF1D1D]a[/color][color=#FF1E1E]v[/color][color=#FF1E1E]e[/color] [color=#FF2020]t[/color][color=#FF2121]h[/color][color=#FF2222]e[/color] [color=#FF2323]d[/color][color=#FF2424]e[/color][color=#FF2525]m[/color][color=#FF2626]o[/color] [color=#FF2424]e[/color][color=#FF2323]n[/color][color=#FF2222]a[/color][color=#FF2222]b[/color][color=#FF2121]l[/color][color=#FF2020]e[/color][color=#FF1F1F]d[/color] [color=#FF1E1E]f[/color][color=#FF1D1D]o[/color][color=#FF1C1C]r[/color] [color=#FF1A1A]a[/color][color=#FF1A1A]c[/color][color=#FF1919]t[/color][color=#FF1818]u[/color][color=#FF1717]a[/color][color=#FF1616]l[/color] [color=#FF1515]g[/color][color=#FF1414]a[/color][color=#FF1313]m[/color][color=#FF1212]e[/color][color=#FF1212]p[/color][color=#FF1111]l[/color][color=#FF1010]a[/color][color=#FF0F0F]y[/color][color=#FF0F0F]![/color][/size] The demo WILL kill your framerate without this mod, and is intended for demonstration purposes only[/spoiler]\n<br />\n<br />\n<br />[b][size=6][color=#44FF00]C[/color][color=#63FF36]R[/color][color=#82FF6D]E[/color][color=#A1FFA4]D[/color][color=#82FF6D]I[/color][color=#63FF36]T[/color][color=#44FF01]S[/color][/size][/b]\n<br />\n<br />[url=https://www.nexusmods.com/skyrimspecialedition/users/2148728]Powerofthree[/url] for mentoring and their wonderful clean source code to reference\n<br />[url=https://www.nexusmods.com/skyrimspecialedition/users/16623]Fuzzles[/url] for being a facilitator, people pusher and tester to rule out any edge cases\n<br />Entire RE discord for helping me get my start in SKSE modding\n<br />[url=https://www.nexusmods.com/skyrimspecialedition/users/93600763]VersuchDrei[/url] for helping with the initial write-up\n<br />[url=https://www.nexusmods.com/skyrimspecialedition/users/28038035]Doodlezoid[/url] for the popup suggestion and modpage changes\n<br />\n<br />Source code is available on my [url=https://github.com/Nightfallstorm/Skyrim-Recursion-FPS-Fix]GitHub[/url]."
url=
hasCustomURL=false
lastNexusQuery=2025-09-16T18:38:33Z
lastNexusUpdate=2025-09-16T18:38:33Z
nexusLastModified=2022-10-27T23:03:38Z
nexusCategory=95
converted=false
validated=false
color=@Variant(\0\0\0\x43\0\xff\xff\0\0\0\0\0\0\0\0)
endorsed=0
tracked=0

[installedFiles]
1\modid=76867
size=1
1\fileid=326984
